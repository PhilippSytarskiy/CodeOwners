name: Require Specific Approvals Based on Dynamic Rules

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-required-approvals:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set GH_TOKEN environment variable
      run: echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

    - name: Get changed files
      id: changed_files
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Получаем изменённые файлы
        gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path' > changed_files.txt
        echo "Changed files:"
        cat changed_files.txt

    - name: Load approval rules from JSON
      id: load_owners
      run: |
        # Путь к approval_rules.json
        cat .github/approval_rules.json

    - name: Get Code Owners Based on Rules
      id: get_owners
      run: |
        # Создаем пустой список владельцев кода
        > codeowners.txt

        # Пробегаем по каждому изменённому файлу и сопоставляем с правилами из JSON
        while IFS= read -r file; do
          echo "Checking owners for $file"
          
          # Ищем подходящее правило для файла
          owner_found=false
          for path in $(jq -r 'keys[]' .github/approval_rules.json); do
            if [[ "$file" == "$path"* ]]; then
              owners=$(jq -r --arg path "$path" '.[$path][]' .github/approval_rules.json)
              echo "Owners for $file: $owners"
              echo "$owners" >> codeowners.txt
              owner_found=true
              break
            fi
          done
          
          if [ "$owner_found" = false ]; then
            echo "No owners found for $file"
          fi
        done < changed_files.txt

        # Убираем дубли из списка владельцев и выводим список владельцев
        sort -u codeowners.txt -o codeowners.txt
        echo "Unique code owners:"
        cat codeowners.txt

        # Подсчитываем количество необходимых апрувов
        REQUIRED_APPROVALS=$(wc -l < codeowners.txt)
        echo "Number of required approvals: $REQUIRED_APPROVALS"

        # Если владельцы найдены, сохраняем минимальное количество апрувов
        if [ "$REQUIRED_APPROVALS" -gt 0 ]; then
          echo "REQUIRED_APPROVALS=$REQUIRED_APPROVALS" >> $GITHUB_ENV
        else
          echo "No code owners found, skipping approvals check."
          exit 0
        fi

    - name: Get PR reviews
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Используем API для получения данных о ревью и выводим их
        gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
          --jq '.[] | select(.state == "APPROVED") | .user.login' > approved_reviewers.json
        echo "Approved reviewers:"
        cat approved_reviewers.json

    - name: Check mandatory approvals
      run: |
        # Инициализация счетчика апрувов
        APPROVALS_COUNT=0

        # Проверяем апрув для каждого владельца кода
        while IFS= read -r owner; do
          if jq -e ". | index(\"${owner}\")" approved_reviewers.json > /dev/null; then
            echo "${owner} has approved the PR."
            APPROVALS_COUNT=$((APPROVALS_COUNT + 1))
          else
            echo "${owner} has NOT approved the PR."
          fi
        done < codeowners.txt

        # Проверяем, установлена ли переменная REQUIRED_APPROVALS
        if [ -z "$REQUIRED_APPROVALS" ]; then
          REQUIRED_APPROVALS=0
        fi

        # Выводим количество апрувов и проверяем достаточно ли их
        echo "Approvals count: $APPROVALS_COUNT out of $REQUIRED_APPROVALS required."
        if [ "$APPROVALS_COUNT" -lt "$REQUIRED_APPROVALS" ]; then
          echo "Not enough approvals from code owners. Required: $REQUIRED_APPROVALS, but got: $APPROVALS_COUNT."
          exit 1
        else
          echo "Sufficient approvals from code owners: $APPROVALS_COUNT out of $REQUIRED_APPROVALS required."
        fi
